on:
  repository_dispatch:
    types: slack-deploy


env:
  IN: ${{ github.event.client_payload.list_of_servers_patched }}
  TAG: ${{ github.event.client_payload.docker_image_tag }}
  ARENA_TAG: ${{ github.event.client_payload.arena_simulation_server_image_tag }}
  STATIC_DATA_VER: ${{ github.event.client_payload.static_data_version }}
  CORE_VERSION_MAP: ${{ github.event.client_payload.core_version_map }}
  DATA_PACK_VERSION_MAP: ${{ github.event.client_payload.data_pack_version_map }}
  MESSAGE_TS: ${{ github.event.client_payload.thread_ts}}
  NO_INPUT: "ì…ë ¥í•œ ê°’ì´ ì—†ìŠµë‹ˆë‹¤"

jobs:
  print-params:
    runs-on: ubuntu-latest
    steps:
      - name: ì…ë ¥ê°’ ì¶œë ¥
        run: |
          printf "%-40s\t: %s\n" \
            "íŒ¨ì¹˜í•  ì„œë²„ ë¦¬ìŠ¤íŠ¸" "${IN:-$NO_INPUT}" \
            "ë„ì»¤ ì´ë¯¸ì§€ íƒœê·¸" "${TAG:-$NO_INPUT}" \
            "ì•„ë ˆë‚˜ ì‹œë®¬ë ˆì´ì…˜ ì„œë²„ ì´ë¯¸ì§€ íƒœê·¸" "${ARENA_TAG:-$NO_INPUT}" \
            "ìŠ¤í…Œí‹± ë°ì´í„° ë²„ì ¼" "${STATIC_DATA_VER:-$NO_INPUT}" \
            "CoreVersionMap" "${CORE_VERSION_MAP:-$NO_INPUT}" \
            "DataPackVersionMap" "${DATA_PACK_VERSION_MAP:-$NO_INPUT}" \
            "message_ts: ìŠ¬ë™ ì±„ë„ì—ì„œ í•´ë‹¹ ì›Œí¬í”Œë¡œìš°ë¡œ ìƒì„±ëœ ë©”ì„¸ì§€ì˜ timestamp(ìŠ¤ë ˆë“œì— ë©”ì„¸ì§€ë¥¼ ë‹¬ê¸° ìœ„í•´ í•„ìš”)" "${MESSAGE_TS:-$NO_INPUT}"

  send-slack-message:
    runs-on: ubuntu-latest
    needs: print-params
    env:
      # #slack-app-devì˜ channel ID
      # TODO: ë‚˜ì¤‘ì— ë©”ì„¸ì§€ë¥¼ ë³´ë‚¼ ì±„ë„ë¡œ ë³€ê²½
      DM_CHANNEL_ID: ${{ secrets.SLACK_GWANHO_DM_CHANNEL_ID }}
      CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}

    steps:
      - name: ì±„ë„ì— broadcast ë©”ì„¸ì§€ ì „ì†¡
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_NK_NOTI_BOT_TOKEN }}
          payload: |
            {
              "channel": "${{ env.CHANNEL_ID }}",
              "thread_ts": "${{ env.MESSAGE_TS }}",
              "text": "ì…ë ¥ê°’ ì „ì†¡",
              "reply_broadcast": true,
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "github actionì—ì„œ í¬ë§¤íŒ… ì˜ ë˜ì–´ ì „ì†¡ë˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ë©”ì„¸ì§€ì…ë‹ˆë‹¤."
                  }
                }
                ${{ env.TAG && format(',{{ "type": "section", "text": {{ "type": "mrkdwn", "text": "{0} *ì„œë²„ ì´ë¯¸ì§€ íƒœê·¸:* `{1}`" }} }}', steps.check-lobby.outcome == 'failure' && 'âŒ' || 'â­•', env.TAG) }}
                ${{ env.ARENA_TAG && format(',{{ "type": "section", "text": {{ "type": "mrkdwn", "text": "{0} *ì•„ë ˆë‚˜ ì‹œë®¬ë ˆì´ì…˜ ì„œë²„ ì´ë¯¸ì§€ íƒœê·¸:* `{1}`" }} }}', steps.check-arena.outcome == 'failure' && 'âŒ' || 'â­•', env.ARENA_TAG) }}
                ${{ env.STATIC_DATA_VER && format(',{{ "type": "section", "text": {{ "type": "mrkdwn", "text": "{0} *ìŠ¤íƒœí‹± ë°ì´í„° ë²„ì „:* `{1}`" }} }}', steps.check-static-data.outcome == 'failure' && 'âŒ' || 'â­•', env.STATIC_DATA_VER) }}
                ,{
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ğŸ”— Run URL>"
                  }
                }
              ]
            }

